<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; color:#111; background:#fafafa; margin:0; }
    .wrap { max-width: 860px; margin: 0 auto; padding: 24px; background:#fff; }
    h1 { font-size: 28px; margin-bottom: 4px; }
    .sub { color:#555; margin-bottom: 16px; }
    .cards { display:flex; gap:12px; flex-wrap:wrap; margin: 8px 0 16px 0; }
    .card { flex:1; min-width:160px; background:#f3f7ff; border:1px solid #e1e8ff; border-radius:12px; padding:12px;}
    .card b { display:block; font-size:12px; color:#3756e6; text-transform:uppercase; letter-spacing:.06em; }
    .card span { font-size:18px; }
    .section { margin: 18px 0 28px 0; }
    img { width:100%; border-radius:8px; border:1px solid #eee; }
    .caption { color:#666; font-size:12px; margin-top:6px; }
    hr { border:none; border-top:1px solid #eee; margin:24px 0; }
    footer { color:#666; font-size:12px; padding:24px 0; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>{{ title }}</h1>
    <div class="sub">Generated {{ timestamp }}</div>

    <div class="cards">
      <div class="card"><b>Cumulative Return</b><span>{{ '%.2f%%' % ((metrics.cum_return or 0)*100) if metrics else 'n/a' }}</span></div>
      <div class="card"><b>Sharpe</b><span>{{ '%.2f' % (metrics.sharpe or 0) if metrics else 'n/a' }}</span></div>
      <div class="card"><b>Max Drawdown</b><span>{{ '%.2f%%' % ((metrics.max_drawdown or 0)*100) if metrics else 'n/a' }}</span></div>
      <div class="card"><b>CAGR</b><span>{{ '%.2f%%' % ((metrics.cagr or 0)*100) if metrics else 'n/a' }}</span></div>
    </div>

    {% if equity_img %}
    <div class="section">
      <h3>Performance Overview</h3>
      <img src="data:image/png;base64,{{ equity_img }}"/>
      <div class="caption">Equity curve across the backtest window.</div>
    </div>
    {% endif %}

    {% if ei_img %}
    <div class="section">
      <h3>Signal Diagnostics</h3>
      <img src="data:image/png;base64,{{ ei_img }}"/>
      <div class="caption">Density of Excitation Index vs 30-minute forward returns.</div>
    </div>
    {% endif %}

    {% if params_img %}
    <div class="section">
      <h3>Parameter Exploration</h3>
      <img src="data:image/png;base64,{{ params_img }}"/>
      <div class="caption">Top parameter sets by Sharpe (grid search).</div>
    </div>
    {% endif %}

    {% if wf_img %}
    <div class="section">
      <h3>Walk-Forward Validation</h3>
      <img src="data:image/png;base64,{{ wf_img }}"/>
      <div class="caption">Out-of-sample test Sharpe by fold.</div>
    </div>
    {% endif %}

    {% if narrative_bundle %}
    <div class="section">
      <h3>{{ narrative_bundle.headline }}</h3>
      <p>{{ narrative_bundle.body }}</p>
      {% if narrative_bundle.sensory_prompts %}
      <ul>
        {% for prompt in narrative_bundle.sensory_prompts %}
        <li>{{ prompt }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if narrative_bundle.interface_cues %}
      <div class="caption">Interface Cues:</div>
      <ul>
        {% for cue in narrative_bundle.interface_cues %}
        <li>{{ cue }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if narrative_bundle.affirmations %}
      <div class="caption">Affirmations:</div>
      <ul>
        {% for affirmation in narrative_bundle.affirmations %}
        <li>{{ affirmation }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    {% elif narrative %}
    <div class="section">
      <h3>Insights</h3>
      <p>{{ narrative }}</p>
    </div>
    {% endif %}

    <hr/>
    <footer>Prepared by {{ author }} â€” Generated by KOLL Research Engine</footer>
  </div>
</body>
</html>
