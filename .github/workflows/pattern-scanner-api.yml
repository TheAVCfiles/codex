name: Pattern Scanner API CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'pattern_scanner_api/**'
      - 'analysis/pattern_scan.py'
      - 'Dockerfile.pattern_scanner'
      - '.github/workflows/pattern-scanner-api.yml'
  pull_request:
    paths:
      - 'pattern_scanner_api/**'
      - 'analysis/pattern_scan.py'
      - 'Dockerfile.pattern_scanner'

jobs:
  test:
    name: Test API
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: pattern_scanner_api/requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r pattern_scanner_api/requirements.txt
          pip install pytest pytest-asyncio httpx
      
      - name: Run tests
        run: |
          # Run pytest if tests exist
          if [ -d "pattern_scanner_api/tests" ]; then
            pytest pattern_scanner_api/tests/ -v
          else
            echo "No tests found, skipping..."
          fi
        env:
          PAYMENT_REQUIRED: "false"
      
      - name: Test API startup
        run: |
          # Start API in background
          export PAYMENT_REQUIRED=false
          uvicorn pattern_scanner_api.main:app --host 127.0.0.1 --port 8000 &
          API_PID=$!
          
          # Wait for API to start
          sleep 5
          
          # Test health endpoint
          curl -f http://127.0.0.1:8000/health || exit 1
          curl -f http://127.0.0.1:8000/patterns || exit 1
          
          # Kill API
          kill $API_PID

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort
      
      - name: Run ruff
        run: |
          ruff check pattern_scanner_api/ --select E,F,W,C,N || true
      
      - name: Check formatting with black
        run: |
          black --check pattern_scanner_api/ || true
      
      - name: Check import order
        run: |
          isort --check-only pattern_scanner_api/ || true

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.pattern_scanner
          push: false
          tags: pattern-scanner-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker image
        run: |
          docker build -f Dockerfile.pattern_scanner -t pattern-scanner-api:test .
          
          # Run container in background
          docker run -d --name test-api \
            -p 8000:8000 \
            -e PAYMENT_REQUIRED=false \
            pattern-scanner-api:test
          
          # Wait for container to start
          sleep 10
          
          # Test health endpoint
          curl -f http://localhost:8000/health || exit 1
          
          # Stop container
          docker stop test-api
          docker rm test-api

  deploy-staging:
    name: Deploy to Fly.io (Staging)
    runs-on: ubuntu-latest
    needs: [docker]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --app pattern-scanner-api-staging
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  deploy-production:
    name: Deploy to Fly.io (Production)
    runs-on: ubuntu-latest
    needs: [docker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --app pattern-scanner-api
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
